<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Raumplan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #floorplan {
            display: grid;
            gap: 0.5rem;
            width: 100%;
            padding: 0.5rem;
        }

        .grid-item {
            border: 2px dashed #e2e8f0;
            border-radius: 1rem;
            min-height: 80px;
            transition: all 0.3s ease;
        }

        .grid-item.drag-over {
            background-color: rgba(var(--room-color-rgb), 0.1);
            border-color: var(--room-color);
        }

        .grid-item:not(:empty) {
            border: none;
        }

        .room {
            min-height: 100px;
            min-width: 200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background-color: white;
        }

        .room:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .room::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 0.25rem;
            background-color: var(--room-color);
        }

        .room-header {
            background-color: var(--room-color);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-name {
            font-size: 1rem;
            font-weight: bold;
        }

        .room-number {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            border-radius: 0.25rem;
        }

        .room-type {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .room-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .room-info {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .room-capacity,
        .amenities {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .room-unavailable {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }

        .amenity-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            background-color: #f0f0f0;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .amenity-icon:hover {
            background-color: #e0e0e0;
        }

        .bookings {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .admin-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .admin-button {
            padding: 0.25rem;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.1);
            color: #333;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }

        .admin-button:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .room.selectable {
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        .favorite-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #ccc;
            transition: color 0.3s ease;
        }

        .favorite-icon.active {
            color: gold;
        }

        .favorite-icon:hover {
            color: gold;
        }

        #floorplan {
            display: grid;
            gap: 1rem;
            width: 100%;
        }

        @media (max-width: 640px) {
            #floorplan {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .room {
                min-height: 60px;
            }

        }

        @media (max-width: 640px) {
            .room {
                font-size: 0.9rem;
            }

            .room-content {
                padding: 0.25rem 0.5rem;
            }

            .room-info {
                flex-wrap: wrap;
            }

            .amenities {
                flex-wrap: wrap;
            }

            .bookings {
                margin-top: 0.25rem;
                white-space: nowrap;
                overflow-x: auto;
                padding-bottom: 0.25rem;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold mb-8 text-center text-gray-800">Interaktiver Raumplan 2. OG</h1>
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Raumplan</h2>
            <div id="selectionHint"
                class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 rounded shadow-md">
                <p class="font-bold">Raumauswahl</p>
                <p>Bitte klicken Sie auf einen Raum, um ihn für Ihre Buchung auszuwählen. Mit der Datumsauswahl können
                    Sie sehen wer zu welchen Zeiten den Raum gebucht hat.</p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8 admin-only">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Verfügbare Räume</h2>
                <div id="availableRooms" class="flex flex-wrap gap-4 mb-6">
                    <!-- Verfügbare Räume werden hier dynamisch hinzugefügt -->
                </div>
                <button id="addRoomBtn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Raum hinzufügen
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Filter</h3>
                <div class="space-y-4">
                    <div class="relative">
                        <input type="text" id="roomFilter" placeholder="Raumname oder -nummer"
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>

                    <div
                        class="date-filter-container flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                        <div class="relative w-full sm:w-auto">
                            <input type="date" id="dateInput"
                                class="w-full sm:w-auto pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <button id="refreshDate"
                            class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                            Aktualisieren
                        </button>
                    </div>

                    <div class="space-y-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="availableOnly" class="form-checkbox h-5 w-5 text-blue-600">
                            <span class="ml-2 text-gray-700">Nur verfügbare Räume</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="favoritesOnly" class="form-checkbox h-5 w-5 text-blue-600">
                            <span class="ml-2 text-gray-700">Nur Favoriten</span>
                        </label>
                    </div>
                </div>
            </div>


            <input type="hidden" id="roomId" name="roomId">
            <div class="mb-4 flex items-center admin-only">
                <label for="gridRows" class="mr-2">Zeilen:</label>
                <input type="number" id="gridRows" min="1" max="20" value="4"
                    class="border rounded px-2 py-1 w-16 mr-4">
                <label for="gridCols" class="mr-2">Spalten:</label>
                <input type="number" id="gridCols" min="1" max="20" value="6"
                    class="border rounded px-2 py-1 w-16 mr-4">
                <button id="updateGridBtn"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded transition duration-300">
                    Grid aktualisieren
                </button>
                <button id="saveGridBtn"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded transition duration-300 ml-4">
                    Grid speichern
                </button>
            </div>

            <div id="floorplan" class="grid gap-4 bg-gray-50 p-4 rounded-lg">
                <!-- Grid für den Raumplan -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Legende</h2>
            <div class="flex flex-wrap gap-4" id="roomTypeLegend">
                <!-- Legende wird hier dynamisch hinzugefügt -->
            </div>
        </div>
    </div>

    <!-- Modal für Raumdetails -->
    <div id="roomModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-8 rounded-lg max-w-md w-full">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800"></h2>
            <form id="roomForm">
                <div class="mb-4">
                    <label for="roomName" class="block mb-2 text-sm font-medium text-gray-700">Raumname:</label>
                    <input type="text" id="roomName"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="roomNumber" class="block mb-2 text-sm font-medium text-gray-700">Raumnummer:</label>
                    <input type="text" id="roomNumber"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="roomType" class="block mb-2 text-sm font-medium text-gray-700">Raumtyp:</label>
                    <select id="roomType"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="mediaroom">Mediaraum</option>
                        <option value="office">Büro</option>
                        <option value="open-office">Großraumbüro</option>
                        <option value="spez-abt-buero">Spez. Abt. Büro</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="roomCapacity" class="block mb-2 text-sm font-medium text-gray-700">Kapazität:</label>
                    <input type="number" id="roomCapacity"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        min="1">
                </div>
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-gray-700">Ausstattung:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities" value="wifi">
                            <span class="ml-2 text-gray-700">WLAN</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities"
                                value="docking-station">
                            <span class="ml-2 text-gray-700">Docking Station</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities" value="desk">
                            <span class="ml-2 text-gray-700">Schreibtisch</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities"
                                value="webcam">
                            <span class="ml-2 text-gray-700">Webcam</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelBtn"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300">Abbrechen</button>
                    <button type="submit"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const floorplan = document.getElementById('floorplan');
        const availableRooms = document.getElementById('availableRooms');
        const addRoomBtn = document.getElementById('addRoomBtn');
        const roomModal = document.getElementById('roomModal');
        const roomForm = document.getElementById('roomForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const gridRowsInput = document.getElementById('gridRows');
        const gridColsInput = document.getElementById('gridCols');
        const updateGridBtn = document.getElementById('updateGridBtn');
        const saveGridBtn = document.getElementById('saveGridBtn');

        let isAdmin = false;
        let isLoggedIn = false;
        let rooms = [];
        let gridConfig = null;

        const roomTypes = {
            'mediaroom': { name: 'Mediaraum', color: '#3b82f6' },
            'office': { name: 'Büro', color: '#10b981' },
            'open-office': { name: 'Großraumbüro', color: '#f59e0b' },
            'spez-abt-buero': { name: 'Spez. Abt. Büro', color: '#8b5cf6' },
            'default': { name: 'Sonstiger Raum', color: '#6b7280' }
        };

        function checkUserStatus() {
            fetch('check_admin.php')
                .then(response => response.json())
                .then(data => {
                    isAdmin = data.isAdmin;
                    isLoggedIn = data.isLoggedIn;
                    updateUIForUserRole();
                    loadInitialData();
                    createLegend();
                })
                .catch(error => console.error('Error:', error));
        }

        function updateUIForUserRole() {
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });

            const roomElements = document.querySelectorAll('.room');
            roomElements.forEach(el => {
                el.draggable = isAdmin;
            });
        }

        async function loadInitialData() {
            try {
                const response = await fetch('load_grid.php');
                const data = await response.json();

                if (data.success) {
                    console.log('Loaded data:', data);
                    gridConfig = data.data.gridConfig;
                    rooms = data.data.rooms.map(room => ({
                        ...room,
                        amenities: room.equipment ? JSON.parse(room.equipment) : []
                    }));

                    console.log('Loaded rooms:', rooms);

                    if (gridConfig) {
                        gridRowsInput.value = gridConfig.rows;
                        gridColsInput.value = gridConfig.cols;
                        updateGrid();

                        // Laden Sie Buchungen für das aktuelle Datum
                        const currentDate = new Date().toISOString().split('T')[0];
                        const bookings = await loadBookingsForDate(currentDate);
                        console.log('Loaded bookings:', bookings);

                        // Platzieren Sie alle Räume auf dem Grid
                        placeAllRoomsOnGrid(rooms, bookings);
                    } else {
                        updateGrid();
                    }

                    updateGridVisual();
                    logGridState();
                } else {
                    console.log('Failed to load data:', data.message);
                    updateGrid();
                }
            } catch (error) {
                console.error('Error:', error);
                updateGrid();
            }
        }

        async function placeAllRoomsOnGrid(rooms) {
            const gridCells = floorplan.children;
            const currentDate = document.getElementById('dateInput').value;
            const bookings = await loadBookingsForDate(currentDate);

            rooms.forEach((room, index) => {
                if (index < gridCells.length) {
                    const roomElement = createRoomElement(room, bookings);
                    gridCells[index].innerHTML = '';
                    gridCells[index].appendChild(roomElement);
                }
            });
        }

        function createRoomElement(room, bookings = []) {
            const roomTypeInfo = roomTypes[room.type] || roomTypes['default'];
            const div = document.createElement('div');
            div.className = 'room';
            div.style.setProperty('--room-color', roomTypeInfo.color);
            div.draggable = isAdmin;
            div.dataset.roomName = room.name;
            div.dataset.roomId = room.id;
            div.dataset.roomType = room.type;

            // Header
            const header = document.createElement('div');
            header.className = 'room-header';
            header.innerHTML = `
        <div class="room-title">
            <h3 class="room-name">${room.name}</h3>
            <div class="room-type">${roomTypeInfo.name}</div>
        </div>
        <div class="room-number">${room.number || 'N/A'}</div>
    `;

            // Favoriten
            const favoriteIcon = document.createElement('button');
            favoriteIcon.className = `favorite-icon ${room.is_favorite ? 'active' : ''}`;
            favoriteIcon.innerHTML = '<i class="fas fa-star"></i>';
            favoriteIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(room.id);
            });
            header.appendChild(favoriteIcon);

            div.appendChild(header);

            // Room Content
            const content = document.createElement('div');
            content.className = 'room-content';

            // Room Info
            const info = document.createElement('div');
            info.className = 'room-info';

            // Kapazität
            const capacity = document.createElement('div');
            capacity.className = 'room-capacity';
            capacity.innerHTML = `
        <i class="fas fa-users"></i>
        <span>${room.capacity}</span>
    `;
            info.appendChild(capacity);

            // Ausstattung
            if (room.amenities && room.amenities.length > 0) {
                const amenities = document.createElement('div');
                amenities.className = 'amenities';
                room.amenities.forEach(amenity => {
                    const icon = document.createElement('div');
                    icon.className = 'amenity-icon';
                    icon.innerHTML = `<i class="fas fa-${getAmenityIcon(amenity)}" title="${getAmenityName(amenity)}"></i>`;
                    amenities.appendChild(icon);
                });
                info.appendChild(amenities);
            }

            content.appendChild(info);

            // Buchungen
            const bookingsDiv = document.createElement('div');
            bookingsDiv.className = 'bookings';
            const roomBookings = bookings.filter(booking => booking.room === room.name);
            if (roomBookings.length > 0) {
                bookingsDiv.innerHTML = '<span class="font-semibold">Buchungen:</span> ' +
                    roomBookings.map(b =>
                        `<span class="booking-item">${b.user_name}: ${b.start_time.substr(0, 5)}-${b.end_time.substr(0, 5)}</span>`
                    ).join(', ');
            } else {
                bookingsDiv.innerHTML = '<span class="text-gray-500">Keine Buchungen</span>';
            }
            content.appendChild(bookingsDiv);

            div.appendChild(content);

            // Admin-Buttons
            if (isAdmin) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'admin-buttons';

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.className = 'admin-button';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showRoomModal(room);
                });
                buttonsDiv.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.className = 'admin-button';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRoom(room);
                });
                buttonsDiv.appendChild(deleteBtn);

                content.appendChild(buttonsDiv);
            }

            if (isAdmin) {
                div.addEventListener('dragstart', dragStart);
            }

            div.addEventListener('click', () => {
                selectRoom(room);
            });

            return div;
        }

        // Hilfsfunktion für Raumtyp-Namen
        function getRoomTypeName(type) {
            const names = {
                'mediaroom': 'Mediaraum',
                'office': 'Büro',
                'open-office': 'Großraumbüro',
                'spez-abt-buero': 'Spez. Abt. Büro'
            };
            return names[type] || 'Sonstiger Raum';
        }
        function getRoomTypeIcon(type) {
            const icons = {
                'mediaroom': 'fa-tv',
                'office': 'fa-briefcase',
                'open-office': 'fa-users',
                'spez-abt-buero': 'fa-star'
            };
            return icons[type] || 'fa-door-open';
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
        }

        function selectRoom(room) {
            if (confirm(`Möchten Sie den Raum "${room.name}" für die Buchung auswählen?`)) {
                window.opener.postMessage({
                    type: 'roomSelected',
                    roomId: room.id,
                    roomName: room.name
                }, '*');

                window.close();
            }
        }

        // Hilfsfunktionen für Ausstattungs-Icons und -Namen
        function getAmenityIcon(amenity) {
            const icons = {
                'wifi': 'wifi',
                'docking-station': 'plug',
                'desk': 'desktop',
                'webcam': 'video'
            };
            return icons[amenity] || 'question';
        }

        function getAmenityName(amenity) {
            const names = {
                'wifi': 'WLAN',
                'docking-station': 'Docking Station',
                'desk': 'Schreibtisch',
                'webcam': 'Webcam'
            };
            return names[amenity] || amenity;
        }

        function toggleFavorite(roomId) {
            fetch('update_favorite.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `favorite_room_id=${roomId}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                        if (roomElement) {
                            const favoriteIcon = roomElement.querySelector('.favorite-icon');
                            favoriteIcon.classList.toggle('active', data.is_favorite);

                            // Aktualisieren Sie den Favoritenstatus im rooms-Array
                            const roomIndex = rooms.findIndex(r => r.id === roomId);
                            if (roomIndex !== -1) {
                                rooms[roomIndex].is_favorite = data.is_favorite;
                            }

                            // Aktualisieren Sie die Raumanordnung
                            updateRoomOrder();
                        }
                    } else {
                        console.error('Fehler beim Aktualisieren des Favoritenstatus:', data.error);
                        if (data.error === 'Nicht eingeloggt') {
                            alert('Bitte loggen Sie sich ein, um Favoriten zu markieren.');
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function updateRoomOrder() {
            const sortedRooms = [...rooms].sort((a, b) => {
                if (a.is_favorite === b.is_favorite) {
                    return a.name.localeCompare(b.name);
                }
                return b.is_favorite - a.is_favorite;
            });

            floorplan.innerHTML = '';
            sortedRooms.forEach(room => {
                const roomElement = createRoomElement(room);
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.appendChild(roomElement);
                floorplan.appendChild(gridItem);
            });

            updateGridVisual();
        }

        async function loadBookingsForDate(date) {
            console.log(`Loading bookings for date: ${date}`);
            try {
                const url = `get_bookings.php?start_date=${date}&end_date=${date}`;
                console.log(`Fetching from URL: ${url}`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const bookings = await response.json();
                console.log('Bookings loaded:', bookings);
                return bookings;
            } catch (error) {
                console.error('Error loading bookings:', error);
                return [];
            }
        }

        function getAmenityName(amenity) {
            const amenityNames = {
                'wifi': 'WLAN',
                'projector': 'Projektor',
                'whiteboard': 'Whiteboard',
                'ac': 'Klimaanlage'
            };
            return amenityNames[amenity] || amenity;
        }

        async function updateGrid() {
            const totalRooms = rooms.length;
            let cols;
            if (window.innerWidth > 640) {
                cols = parseInt(gridColsInput.value);
            } else {
                cols = 1; // Eine Spalte für mobile Geräte
            }
            const rows = Math.ceil(totalRooms / cols);

            gridRowsInput.value = rows;
            gridColsInput.value = cols;

            floorplan.innerHTML = '';
            floorplan.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            floorplan.style.gridAutoRows = 'minmax(80px, auto)';

            for (let i = 0; i < totalRooms; i++) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.addEventListener('dragover', dragOver);
                gridItem.addEventListener('dragleave', dragLeave);
                gridItem.addEventListener('drop', drop);
                floorplan.appendChild(gridItem);
            }

            await placeAllRoomsOnGrid(rooms);
            updateGridVisual();
        }

        function logGridState() {
            console.log('Current grid state:');
            Array.from(floorplan.children).forEach((cell, index) => {
                const roomElement = cell.querySelector('.room');
                if (roomElement) {
                    console.log(`Cell ${index}: Room ${roomElement.dataset.roomName} (ID: ${roomElement.dataset.roomId})`);
                } else {
                    console.log(`Cell ${index}: Empty`);
                }
            });
        }

        function updateGridLayout() {
            const layout = Array.from(floorplan.children).map(item => {
                const roomElement = item.firstElementChild;
                return roomElement ? roomElement.dataset.roomId : null;
            });

            fetch('update_grid_layout.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    layout,
                    rows: parseInt(gridRowsInput.value),
                    cols: parseInt(gridColsInput.value)
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to update grid layout:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error updating grid layout:', error);
                });
        }

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.roomId);
        }

        function dragOver(e) {
            e.preventDefault();
            if (this.children.length === 0) {
                this.classList.add('drag-over');
                const roomId = e.dataTransfer.getData('text');
                const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                if (roomElement) {
                    const roomColor = getComputedStyle(roomElement).getPropertyValue('--room-color');
                    this.style.setProperty('--room-color', roomColor);
                    this.style.setProperty('--room-color-rgb', hexToRgb(roomColor));
                }
            }
        }

        function dragLeave(e) {
            this.classList.remove('drag-over');
            this.style.removeProperty('--room-color');
            this.style.removeProperty('--room-color-rgb');
        }

        function drop(e) {
            e.preventDefault();
            const roomId = e.dataTransfer.getData('text');
            const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);

            if (roomElement && e.target.classList.contains('grid-item') && e.target.children.length === 0) {
                e.target.innerHTML = '';
                e.target.appendChild(roomElement);
                roomElement.style.width = '100%';
                roomElement.style.height = '100%';

                updateGridLayout();
            }

            this.classList.remove('drag-over');
            this.style.removeProperty('--room-color');
            this.style.removeProperty('--room-color-rgb');
        }

        function initializeRooms() {
            console.log('Initializing rooms');
            if (isAdmin) {
                availableRooms.innerHTML = '';
                rooms.forEach(room => {
                    if (!document.querySelector(`[data-room-id="${room.id}"]`)) {
                        console.log('Adding room to available rooms:', room);
                        const roomElement = createRoomElement(room);
                        availableRooms.appendChild(roomElement);
                    }
                });
            }
            console.log('Available rooms after initialization:', availableRooms.children.length);
        }

        function showRoomModal(room = null) {
            const modalTitle = document.getElementById('modalTitle');
            const roomIdInput = document.getElementById('roomId');
            const roomNameInput = document.getElementById('roomName');
            const roomNumberInput = document.getElementById('roomNumber');
            const roomTypeSelect = document.getElementById('roomType');
            const roomCapacityInput = document.getElementById('roomCapacity');
            const amenitiesCheckboxes = document.querySelectorAll('input[name="amenities"]');

            if (room) {
                modalTitle.textContent = 'Raum bearbeiten';
                roomIdInput.value = room.id;
                roomNameInput.value = room.name;
                roomNumberInput.value = room.number;
                roomTypeSelect.value = room.type;
                roomCapacityInput.value = room.capacity;
                amenitiesCheckboxes.forEach(checkbox => {
                    checkbox.checked = room.amenities.includes(checkbox.value);
                });
            } else {
                modalTitle.textContent = 'Neuen Raum hinzufügen';
                roomIdInput.value = '';
                roomNameInput.value = '';
                roomNumberInput.value = '';
                roomTypeSelect.value = 'office';
                roomCapacityInput.value = '';
                amenitiesCheckboxes.forEach(checkbox => checkbox.checked = false);
            }

            roomModal.classList.remove('hidden');
            roomModal.classList.add('flex');
        }

        function hideRoomModal() {
            roomModal.classList.add('hidden');
            roomModal.classList.remove('flex');
        }

        function addOrUpdateRoom(e) {
            e.preventDefault();
            const roomId = document.getElementById('roomId').value; // Fügen Sie ein verstecktes Feld für die ID hinzu
            const roomName = document.getElementById('roomName').value;
            const roomNumber = document.getElementById('roomNumber').value;
            const roomType = document.getElementById('roomType').value;
            const roomCapacity = parseInt(document.getElementById('roomCapacity').value);
            const amenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(cb => cb.value);

            const roomData = {
                name: roomName,
                number: roomNumber,
                type: roomType,
                capacity: roomCapacity,
                amenities: amenities,
                grid_position: null // Wird nur für neue Räume verwendet
            };

            if (roomId) {
                roomData.id = roomId;
            }

            const url = roomId ? 'update_room.php' : 'add_room.php';

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(roomData),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (roomId) {
                            // Aktualisieren des bestehenden Raums
                            const index = rooms.findIndex(r => r.id.toString() === roomId);
                            if (index !== -1) {
                                rooms[index] = { ...rooms[index], ...roomData };
                                // Aktualisieren des bestehenden Raumelements im Grid oder in availableRooms
                                const existingRoomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                                if (existingRoomElement) {
                                    const newRoomElement = createRoomElement(rooms[index]);
                                    existingRoomElement.parentNode.replaceChild(newRoomElement, existingRoomElement);
                                }
                            }
                        } else {
                            // Hinzufügen eines neuen Raums
                            const newRoom = { ...roomData, id: data.roomId };
                            rooms.push(newRoom);
                            const roomElement = createRoomElement(newRoom);
                            availableRooms.appendChild(roomElement);
                        }
                        hideRoomModal();
                        updateGridVisual();
                    } else {
                        alert('Fehler beim Speichern des Raums: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Fehler beim Speichern des Raums');
                });
        }

        function deleteRoom(room) {
            if (confirm(`Sind Sie sicher, dass Sie den Raum ${room.name} löschen möchten?`)) {
                fetch('delete_room.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ roomId: room.id }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            rooms = rooms.filter(r => r.id !== room.id);

                            // Entfernen Sie den Raum aus dem Grid
                            const roomElement = document.querySelector(`[data-room-id="${room.id}"]`);
                            if (roomElement && roomElement.parentElement) {
                                roomElement.parentElement.removeChild(roomElement);
                            }

                            updateGridLayout();
                            initializeRooms();
                        } else {
                            alert('Fehler beim Löschen des Raums: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Fehler beim Löschen des Raums');
                    });
            }
        }

        function updateGridVisual() {
            floorplan.querySelectorAll('.grid-item').forEach((cell) => {
                const existingCellNumber = cell.querySelector('.cell-number');
                if (existingCellNumber) {
                    existingCellNumber.remove();
                }

                cell.style.border = '1px solid #ccc';
                cell.style.position = 'relative';
                cell.style.minHeight = '100px';
            });
        }

        function saveGrid() {
            const layout = Array.from(floorplan.children).map(item => {
                const roomElement = item.firstElementChild;
                return roomElement ? roomElement.dataset.roomId : null;
            });

            fetch('save_grid.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    layout,
                    rows: parseInt(gridRowsInput.value),
                    cols: parseInt(gridColsInput.value)
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Grid-Layout erfolgreich gespeichert');
                    } else {
                        console.error('Failed to save grid layout:', data.message);
                        alert('Fehler beim Speichern des Grid-Layouts');
                    }
                })
                .catch(error => {
                    console.error('Error saving grid layout:', error);
                    alert('Fehler beim Speichern des Grid-Layouts');
                });
        }

        function createLegend() {
            const legendContainer = document.getElementById('roomTypeLegend');
            legendContainer.innerHTML = ''; // Leert den Container

            Object.entries(roomTypes).forEach(([type, info]) => {
                if (type !== 'default') {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `
                <div class="legend-color" style="background-color: ${info.color};"></div>
                <span>${info.name}</span>
            `;
                    legendContainer.appendChild(legendItem);
                }
            });
        }

        addRoomBtn.addEventListener('click', () => showRoomModal());
        roomForm.addEventListener('submit', addOrUpdateRoom);
        cancelBtn.addEventListener('click', hideRoomModal);
        updateGridBtn.addEventListener('click', updateGrid);
        saveGridBtn.addEventListener('click', saveGrid);

        gridRowsInput.addEventListener('change', () => {
            if (parseInt(gridRowsInput.value) < 1) gridRowsInput.value = 1;
            if (parseInt(gridRowsInput.value) > 20) gridRowsInput.value = 20;
        });

        gridColsInput.addEventListener('change', () => {
            if (parseInt(gridColsInput.value) < 1) gridColsInput.value = 1;
            if (parseInt(gridColsInput.value) > 20) gridColsInput.value = 20;
        });

        document.getElementById('refreshDate').addEventListener('click', () => {
            const selectedDate = document.getElementById('dateInput').value;
            changeDateAndRefresh(selectedDate);
        });

        document.getElementById('dateInput').valueAsDate = new Date();

        function changeDateAndRefresh(date) {
            loadBookingsForDate(date).then(bookings => {
                rooms.forEach(room => {
                    const roomElement = document.querySelector(`[data-room-id="${room.id}"]`);
                    if (roomElement) {
                        const newRoomElement = createRoomElement(room, bookings);
                        roomElement.parentNode.replaceChild(newRoomElement, roomElement);
                    }
                });
                filterRooms();
            });
        }

        const roomFilter = document.getElementById('roomFilter');
        const availableOnlyCheckbox = document.getElementById('availableOnly');
        const favoritesOnlyCheckbox = document.getElementById('favoritesOnly');

        async function filterRooms() {
            console.log('filterRooms function called');
            const filterText = roomFilter.value.toLowerCase();
            const showAvailableOnly = availableOnlyCheckbox.checked;
            const showFavoritesOnly = favoritesOnlyCheckbox.checked;
            const selectedDate = document.getElementById('dateInput').value;
            console.log(`Filter settings: text="${filterText}", availableOnly=${showAvailableOnly}, favoritesOnly=${showFavoritesOnly}, date=${selectedDate}`);

            const bookings = await loadBookingsForDate(selectedDate);
            console.log('Bookings loaded:', bookings);

            rooms.forEach(room => {
                const roomElement = document.querySelector(`[data-room-id="${room.id}"]`);
                if (roomElement) {
                    const roomName = room.name.toLowerCase();
                    const roomNumber = room.number.toLowerCase();
                    const matchesFilter = roomName.includes(filterText) || roomNumber.includes(filterText);

                    const roomBookings = bookings.filter(booking => booking.room === room.name);
                    const occupiedSeats = calculateOccupiedSeats(roomBookings, selectedDate);
                    const availableSeats = Math.max(0, room.capacity - occupiedSeats);
                    const isAvailable = availableSeats > 0;

                    console.log(`Room: ${room.name}, Capacity: ${room.capacity}, Bookings: ${roomBookings.length}, Occupied: ${occupiedSeats}, Available: ${availableSeats}, IsAvailable: ${isAvailable}`);

                    const matchesFavorite = !showFavoritesOnly || room.is_favorite;

                    // Determine visibility based on text filter and favorites
                    const isVisible = matchesFilter && matchesFavorite;

                    // Apply the unavailable style if the room is not available and the filter is active
                    const shouldBeUnavailable = !isAvailable && showAvailableOnly;
                    roomElement.classList.toggle('room-unavailable', shouldBeUnavailable);

                    // Set display style based on visibility (text filter and favorites only)
                    roomElement.style.display = isVisible ? '' : 'none';

                    updateCapacityDisplay(roomElement, availableSeats, room.capacity);

                    console.log(`Room: ${room.name}, IsVisible: ${isVisible}, IsAvailable: ${isAvailable}, ShouldBeUnavailable: ${shouldBeUnavailable}, ClassList: ${roomElement.classList}`);
                }
            });
        }

        function updateCapacityDisplay(roomElement, availableSeats, totalCapacity) {
            const capacityElement = roomElement.querySelector('.room-capacity span');
            if (capacityElement) {
                capacityElement.textContent = `${availableSeats}/${totalCapacity}`;
                if (availableSeats === 0) {
                    capacityElement.classList.add('text-red-500');
                } else if (availableSeats < totalCapacity / 2) {
                    capacityElement.classList.add('text-yellow-500');
                } else {
                    capacityElement.classList.add('text-green-500');
                }
            }
        }

        availableOnlyCheckbox.addEventListener('change', filterRooms);
        favoritesOnlyCheckbox.addEventListener('change', filterRooms);
        roomFilter.addEventListener('input', filterRooms);

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function calculateOccupiedSeats(bookings, date) {
            return bookings.length;
        }

        document.getElementById('dateInput').addEventListener('change', (e) => {
            changeDateAndRefresh(e.target.value);
            filterRooms();
        });

        // Initialisierung
        checkUserStatus();
        filterRooms();
    </script>
</body>

</html>