<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Raumplan 2. OG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .room {
            transition: all 0.3s ease;
            cursor: move;
        }

        .room:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .grid-item {
            border: 1px dashed #e2e8f0;
            min-height: 80px;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold mb-8 text-center text-gray-800">Interaktiver Raumplan 2. OG</h1>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 admin-only">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Verfügbare Räume</h2>
            <div id="availableRooms" class="flex flex-wrap gap-4 mb-6">
                <!-- Verfügbare Räume werden hier dynamisch hinzugefügt -->
            </div>
            <button id="addRoomBtn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105">
                <i class="fas fa-plus mr-2"></i>Raum hinzufügen
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Raumplan</h2>
            <div class="mb-4">
                <label for="dateInput" class="mr-2">Datum:</label>
                <input type="date" id="dateInput" class="border rounded px-2 py-1">
                <button id="refreshDate"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded ml-2">
                    Aktualisieren
                </button>
            </div>
            <input type="hidden" id="roomId" name="roomId">
            <div class="mb-4 flex items-center admin-only">
                <label for="gridRows" class="mr-2">Zeilen:</label>
                <input type="number" id="gridRows" min="1" max="20" value="4"
                    class="border rounded px-2 py-1 w-16 mr-4">
                <label for="gridCols" class="mr-2">Spalten:</label>
                <input type="number" id="gridCols" min="1" max="20" value="6"
                    class="border rounded px-2 py-1 w-16 mr-4">
                <button id="updateGridBtn"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded transition duration-300">
                    Grid aktualisieren
                </button>
                <button id="saveGridBtn"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded transition duration-300 ml-4">
                    Grid speichern
                </button>
            </div>
            <div id="floorplan" class="grid gap-4 bg-gray-50 p-4 rounded-lg">
                <!-- Grid für den Raumplan -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 admin-only">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Legende</h2>
            <div class="flex flex-wrap gap-6">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-blue-300 mr-3 rounded"></div>
                    <span class="text-gray-700">Mediaraum</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-green-300 mr-3 rounded"></div>
                    <span class="text-gray-700">Büro</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-yellow-300 mr-3 rounded"></div>
                    <span class="text-gray-700">Großraumbüro</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-purple-300 mr-3 rounded"></div>
                    <span class="text-gray-700">Spez. Abt. Büro</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal für Raumdetails -->
    <div id="roomModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-8 rounded-lg max-w-md w-full">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800"></h2>
            <form id="roomForm">
                <div class="mb-4">
                    <label for="roomName" class="block mb-2 text-sm font-medium text-gray-700">Raumname:</label>
                    <input type="text" id="roomName"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="roomNumber" class="block mb-2 text-sm font-medium text-gray-700">Raumnummer:</label>
                    <input type="text" id="roomNumber"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="roomType" class="block mb-2 text-sm font-medium text-gray-700">Raumtyp:</label>
                    <select id="roomType"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="mediaroom">Mediaraum</option>
                        <option value="office">Büro</option>
                        <option value="open-office">Großraumbüro</option>
                        <option value="spez-abt-buero">Spez. Abt. Büro</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="roomCapacity" class="block mb-2 text-sm font-medium text-gray-700">Kapazität:</label>
                    <input type="number" id="roomCapacity"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        min="1">
                </div>
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-gray-700">Ausstattung:</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities" value="wifi">
                            <span class="ml-2 text-gray-700">WLAN</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities"
                                value="docking-station">
                            <span class="ml-2 text-gray-700">Docking Station</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities" value="desk">
                            <span class="ml-2 text-gray-700">Schreibtisch</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox text-indigo-600" name="amenities"
                                value="webcam">
                            <span class="ml-2 text-gray-700">Webcam</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelBtn"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-300">Abbrechen</button>
                    <button type="submit"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const floorplan = document.getElementById('floorplan');
        const availableRooms = document.getElementById('availableRooms');
        const addRoomBtn = document.getElementById('addRoomBtn');
        const roomModal = document.getElementById('roomModal');
        const roomForm = document.getElementById('roomForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const gridRowsInput = document.getElementById('gridRows');
        const gridColsInput = document.getElementById('gridCols');
        const updateGridBtn = document.getElementById('updateGridBtn');
        const saveGridBtn = document.getElementById('saveGridBtn');

        let isAdmin = false;
        let isLoggedIn = false;
        let rooms = [];
        let gridConfig = null;

        const roomTypes = {
            'mediaroom': { name: 'Mediaraum', classes: 'bg-blue-100 text-blue-800 border border-blue-300' },
            'office': { name: 'Büro', classes: 'bg-green-100 text-green-800 border border-green-300' },
            'open-office': { name: 'Großraumbüro', classes: 'bg-yellow-100 text-yellow-800 border border-yellow-300' },
            'spez-abt-buero': { name: 'Spez. Abt. Büro', classes: 'bg-purple-100 text-purple-800 border border-purple-300' },
            'default': { name: 'Sonstiger Raum', classes: 'bg-gray-100 text-gray-800 border border-gray-300' }
        };

        function checkUserStatus() {
            fetch('check_admin.php')
                .then(response => response.json())
                .then(data => {
                    isAdmin = data.isAdmin;
                    isLoggedIn = data.isLoggedIn;
                    updateUIForUserRole();
                    loadInitialData();
                })
                .catch(error => console.error('Error:', error));
        }

        function updateUIForUserRole() {
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });

            const roomElements = document.querySelectorAll('.room');
            roomElements.forEach(el => {
                el.draggable = isAdmin;
            });
        }

        async function loadInitialData() {
            try {
                const response = await fetch('load_grid.php');
                const data = await response.json();

                if (data.success) {
                    console.log('Loaded data:', data);
                    gridConfig = data.data.gridConfig;
                    rooms = data.data.rooms.map(room => ({
                        ...room,
                        amenities: room.equipment ? JSON.parse(room.equipment) : []
                    }));

                    console.log('Loaded rooms:', rooms);

                    if (gridConfig) {
                        gridRowsInput.value = gridConfig.rows;
                        gridColsInput.value = gridConfig.cols;
                        updateGrid();

                        let roomLayout;
                        try {
                            roomLayout = JSON.parse(gridConfig.room_layout);
                            console.log('Parsed room layout:', roomLayout);
                        } catch (error) {
                            console.error('Error parsing room_layout:', error);
                            roomLayout = [];
                        }

                        // Laden Sie Buchungen für das aktuelle Datum
                        const currentDate = new Date().toISOString().split('T')[0];
                        const bookings = await loadBookingsForDate(currentDate);
                        console.log('Loaded bookings:', bookings);

                        roomLayout.forEach((roomId, index) => {
                            if (roomId) {
                                const room = rooms.find(r => r.id.toString() === roomId.toString());
                                if (room) {
                                    console.log('Placing room:', room, 'at index:', index);
                                    const roomElement = createRoomElement(room, bookings);
                                    if (floorplan.children[index]) {
                                        floorplan.children[index].innerHTML = '';
                                        floorplan.children[index].appendChild(roomElement);
                                        console.log('Room placed successfully');
                                    } else {
                                        console.error('Grid cell not found at index:', index);
                                    }
                                } else {
                                    console.log('Room not found for id:', roomId);
                                }
                            }
                        });
                    } else {
                        updateGrid();
                    }

                    initializeRooms();
                    updateGridVisual();
                    logGridState();
                } else {
                    console.log('Failed to load data:', data.message);
                    updateGrid();
                }
            } catch (error) {
                console.error('Error:', error);
                updateGrid();
            }
        }

        function createRoomElement(room, bookings = []) {
            const roomTypeInfo = roomTypes[room.type] || roomTypes['default'];
            const div = document.createElement('div');
            div.className = `room rounded-lg flex flex-col p-4 ${roomTypeInfo.classes} shadow-md relative overflow-hidden transition-all duration-300 hover:shadow-lg`;
            div.style.minHeight = '180px';
            div.draggable = isAdmin;
            div.dataset.roomName = room.name;
            div.dataset.roomId = room.id;
            div.dataset.roomType = room.type;

            // Raumname und Nummer
            const headerDiv = document.createElement('div');
            headerDiv.className = 'mb-2 text-center';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = room.name;
            nameSpan.className = 'font-bold text-lg';
            headerDiv.appendChild(nameSpan);

            const numberSpan = document.createElement('span');
            numberSpan.textContent = room.number ? ` (${room.number})` : '';
            numberSpan.className = 'text-sm text-gray-600 ml-1';
            headerDiv.appendChild(numberSpan);

            div.appendChild(headerDiv);

            // Kapazität
            const capacitySpan = document.createElement('span');
            capacitySpan.textContent = `Kapazität: ${room.capacity}`;
            capacitySpan.className = 'text-sm mb-2 text-center';
            div.appendChild(capacitySpan);

            // Buchungsinformationen
            const roomBookings = bookings.filter(booking => booking.room === room.name);
            if (roomBookings.length > 0) {
                const bookingInfo = document.createElement('div');
                bookingInfo.className = 'text-xs mt-2 bg-yellow-100 p-2 rounded';
                bookingInfo.innerHTML = '<span class="font-semibold block mb-1">Buchungen:</span>' +
                    roomBookings.map(b =>
                        `<span class="font-bold">${b.user_name}</span>: ${b.start_time.substr(0, 5)}-${b.end_time.substr(0, 5)}`
                    ).join('<br>');
                div.appendChild(bookingInfo);
            }

            // Ausstattung als Icons
            if (room.amenities && room.amenities.length > 0) {
                const amenitiesDiv = document.createElement('div');
                amenitiesDiv.className = 'flex justify-center gap-2 mt-2';
                room.amenities.forEach(amenity => {
                    const iconWrapper = document.createElement('div');
                    iconWrapper.className = 'relative';

                    const icon = document.createElement('i');
                    icon.className = `fas fa-${getAmenityIcon(amenity)} text-gray-600 cursor-pointer`;
                    iconWrapper.appendChild(icon);

                    const tooltip = document.createElement('div');
                    tooltip.className = 'absolute hidden bg-black text-white text-xs rounded py-1 px-2 bottom-full left-1/2 transform -translate-x-1/2 mb-1';
                    tooltip.textContent = getAmenityName(amenity);
                    iconWrapper.appendChild(tooltip);

                    iconWrapper.addEventListener('mouseenter', () => tooltip.classList.remove('hidden'));
                    iconWrapper.addEventListener('mouseleave', () => tooltip.classList.add('hidden'));

                    amenitiesDiv.appendChild(iconWrapper);
                });
                div.appendChild(amenitiesDiv);
            }

            if (isAdmin) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex gap-2 mt-2 justify-center';

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.className = 'bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition duration-300';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showRoomModal(room);
                });
                buttonsDiv.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.className = 'bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition duration-300';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRoom(room);
                });
                buttonsDiv.appendChild(deleteBtn);

                div.appendChild(buttonsDiv);
            }

            if (isAdmin) {
                div.addEventListener('dragstart', dragStart);
            }

            div.addEventListener('click', () => {
                selectRoom(room);
            });

            return div;
        }

        function selectRoom(room) {
            if (confirm(`Möchten Sie den Raum "${room.name}" für die Buchung auswählen?`)) {
                window.opener.postMessage({
                    type: 'roomSelected',
                    roomId: room.id,
                    roomName: room.name
                }, '*');

                window.close();
            }
        }

        // Hilfsfunktionen für Ausstattungs-Icons und -Namen
        function getAmenityIcon(amenity) {
            const icons = {
                'wifi': 'wifi',
                'docking-station': 'plug',
                'desk': 'desktop',
                'webcam': 'video'
            };
            return icons[amenity] || 'question';
        }

        function getAmenityName(amenity) {
            const names = {
                'wifi': 'WLAN',
                'docking-station': 'Docking Station',
                'desk': 'Schreibtisch',
                'webcam': 'Webcam'
            };
            return names[amenity] || amenity;
        }

        async function loadBookingsForDate(date) {
            try {
                const response = await fetch(`get_bookings.php?start_date=${date}&end_date=${date}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const bookings = await response.json();
                return bookings;
            } catch (error) {
                console.error('Error loading bookings:', error);
                return [];
            }
        }

        function getAmenityName(amenity) {
            const amenityNames = {
                'wifi': 'WLAN',
                'projector': 'Projektor',
                'whiteboard': 'Whiteboard',
                'ac': 'Klimaanlage'
            };
            return amenityNames[amenity] || amenity;
        }

        function updateGrid() {
            const rows = parseInt(gridRowsInput.value);
            const cols = parseInt(gridColsInput.value);

            floorplan.innerHTML = '';
            floorplan.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            floorplan.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;

            for (let i = 0; i < rows * cols; i++) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.addEventListener('dragover', dragOver);
                gridItem.addEventListener('drop', drop);
                floorplan.appendChild(gridItem);
            }

            updateGridVisual();
        }


        function logGridState() {
            console.log('Current grid state:');
            Array.from(floorplan.children).forEach((cell, index) => {
                const roomElement = cell.querySelector('.room');
                if (roomElement) {
                    console.log(`Cell ${index}: Room ${roomElement.dataset.roomName} (ID: ${roomElement.dataset.roomId})`);
                } else {
                    console.log(`Cell ${index}: Empty`);
                }
            });
        }

        function updateGridLayout() {
            const layout = Array.from(floorplan.children).map(item => {
                const roomElement = item.firstElementChild;
                return roomElement ? roomElement.dataset.roomId : null;
            });

            fetch('update_grid_layout.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    layout,
                    rows: parseInt(gridRowsInput.value),
                    cols: parseInt(gridColsInput.value)
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to update grid layout:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error updating grid layout:', error);
                });
        }

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.roomId);
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function drop(e) {
            e.preventDefault();
            const roomId = e.dataTransfer.getData('text');
            const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);

            if (roomElement && e.target.classList.contains('grid-item')) {
                // Entfernen Sie den Raum aus seinem vorherigen Container
                if (roomElement.parentElement) {
                    roomElement.parentElement.removeChild(roomElement);
                }

                // Fügen Sie den Raum zum neuen Grid-Item hinzu
                e.target.innerHTML = '';
                e.target.appendChild(roomElement);
                roomElement.style.width = '100%';
                roomElement.style.height = '100%';

                updateGridLayout();
            }
        }

        function initializeRooms() {
            console.log('Initializing rooms');
            if (isAdmin) {
                availableRooms.innerHTML = '';
                rooms.forEach(room => {
                    if (!document.querySelector(`[data-room-id="${room.id}"]`)) {
                        console.log('Adding room to available rooms:', room);
                        const roomElement = createRoomElement(room);
                        availableRooms.appendChild(roomElement);
                    }
                });
            }
            console.log('Available rooms after initialization:', availableRooms.children.length);
        }

        function showRoomModal(room = null) {
            const modalTitle = document.getElementById('modalTitle');
            const roomIdInput = document.getElementById('roomId');
            const roomNameInput = document.getElementById('roomName');
            const roomNumberInput = document.getElementById('roomNumber');
            const roomTypeSelect = document.getElementById('roomType');
            const roomCapacityInput = document.getElementById('roomCapacity');
            const amenitiesCheckboxes = document.querySelectorAll('input[name="amenities"]');

            if (room) {
                modalTitle.textContent = 'Raum bearbeiten';
                roomIdInput.value = room.id;
                roomNameInput.value = room.name;
                roomNumberInput.value = room.number;
                roomTypeSelect.value = room.type;
                roomCapacityInput.value = room.capacity;
                amenitiesCheckboxes.forEach(checkbox => {
                    checkbox.checked = room.amenities.includes(checkbox.value);
                });
            } else {
                modalTitle.textContent = 'Neuen Raum hinzufügen';
                roomIdInput.value = '';
                roomNameInput.value = '';
                roomNumberInput.value = '';
                roomTypeSelect.value = 'office';
                roomCapacityInput.value = '';
                amenitiesCheckboxes.forEach(checkbox => checkbox.checked = false);
            }

            roomModal.classList.remove('hidden');
            roomModal.classList.add('flex');
        }

        function hideRoomModal() {
            roomModal.classList.add('hidden');
            roomModal.classList.remove('flex');
        }

        function addOrUpdateRoom(e) {
            e.preventDefault();
            const roomId = document.getElementById('roomId').value; // Fügen Sie ein verstecktes Feld für die ID hinzu
            const roomName = document.getElementById('roomName').value;
            const roomNumber = document.getElementById('roomNumber').value;
            const roomType = document.getElementById('roomType').value;
            const roomCapacity = parseInt(document.getElementById('roomCapacity').value);
            const amenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(cb => cb.value);

            const roomData = {
                name: roomName,
                number: roomNumber,
                type: roomType,
                capacity: roomCapacity,
                amenities: amenities,
                grid_position: null // Wird nur für neue Räume verwendet
            };

            if (roomId) {
                roomData.id = roomId;
            }

            const url = roomId ? 'update_room.php' : 'add_room.php';

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(roomData),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (roomId) {
                            // Aktualisieren des bestehenden Raums
                            const index = rooms.findIndex(r => r.id.toString() === roomId);
                            if (index !== -1) {
                                rooms[index] = { ...rooms[index], ...roomData };
                                // Aktualisieren des bestehenden Raumelements im Grid oder in availableRooms
                                const existingRoomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                                if (existingRoomElement) {
                                    const newRoomElement = createRoomElement(rooms[index]);
                                    existingRoomElement.parentNode.replaceChild(newRoomElement, existingRoomElement);
                                }
                            }
                        } else {
                            // Hinzufügen eines neuen Raums
                            const newRoom = { ...roomData, id: data.roomId };
                            rooms.push(newRoom);
                            const roomElement = createRoomElement(newRoom);
                            availableRooms.appendChild(roomElement);
                        }
                        hideRoomModal();
                        updateGridVisual();
                    } else {
                        alert('Fehler beim Speichern des Raums: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Fehler beim Speichern des Raums');
                });
        }

        function deleteRoom(room) {
            if (confirm(`Sind Sie sicher, dass Sie den Raum ${room.name} löschen möchten?`)) {
                fetch('delete_room.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ roomId: room.id }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            rooms = rooms.filter(r => r.id !== room.id);

                            // Entfernen Sie den Raum aus dem Grid
                            const roomElement = document.querySelector(`[data-room-id="${room.id}"]`);
                            if (roomElement && roomElement.parentElement) {
                                roomElement.parentElement.removeChild(roomElement);
                            }

                            updateGridLayout();
                            initializeRooms();
                        } else {
                            alert('Fehler beim Löschen des Raums: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Fehler beim Löschen des Raums');
                    });
            }
        }

        function updateGridVisual() {
            floorplan.querySelectorAll('.grid-item').forEach((cell) => {
                const existingCellNumber = cell.querySelector('.cell-number');
                if (existingCellNumber) {
                    existingCellNumber.remove();
                }

                cell.style.border = '1px solid #ccc';
                cell.style.position = 'relative';
                cell.style.minHeight = '100px';
            });
        }

        function saveGrid() {
            const layout = Array.from(floorplan.children).map(item => {
                const roomElement = item.firstElementChild;
                return roomElement ? roomElement.dataset.roomId : null;
            });

            fetch('save_grid.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    layout,
                    rows: parseInt(gridRowsInput.value),
                    cols: parseInt(gridColsInput.value)
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Grid-Layout erfolgreich gespeichert');
                    } else {
                        console.error('Failed to save grid layout:', data.message);
                        alert('Fehler beim Speichern des Grid-Layouts');
                    }
                })
                .catch(error => {
                    console.error('Error saving grid layout:', error);
                    alert('Fehler beim Speichern des Grid-Layouts');
                });
        }

        addRoomBtn.addEventListener('click', () => showRoomModal());
        roomForm.addEventListener('submit', addOrUpdateRoom);
        cancelBtn.addEventListener('click', hideRoomModal);
        updateGridBtn.addEventListener('click', updateGrid);
        saveGridBtn.addEventListener('click', saveGrid);

        gridRowsInput.addEventListener('change', () => {
            if (parseInt(gridRowsInput.value) < 1) gridRowsInput.value = 1;
            if (parseInt(gridRowsInput.value) > 20) gridRowsInput.value = 20;
        });

        gridColsInput.addEventListener('change', () => {
            if (parseInt(gridColsInput.value) < 1) gridColsInput.value = 1;
            if (parseInt(gridColsInput.value) > 20) gridColsInput.value = 20;
        });

        document.getElementById('refreshDate').addEventListener('click', () => {
            const selectedDate = document.getElementById('dateInput').value;
            changeDateAndRefresh(selectedDate);
        });

        document.getElementById('dateInput').valueAsDate = new Date();

        function changeDateAndRefresh(date) {
            loadBookingsForDate(date).then(bookings => {
                rooms.forEach(room => {
                    const roomElement = document.querySelector(`[data-room-id="${room.id}"]`);
                    if (roomElement) {
                        const newRoomElement = createRoomElement(room, bookings);
                        roomElement.parentNode.replaceChild(newRoomElement, roomElement);
                    }
                });
            });
        }

        // Initialisierung
        checkUserStatus();
    </script>
</body>

</html>